/*!  build: Vue Shop Vite 
     copyright: https://vue-admin-beautiful.com/shop-vite  
     time: 2025-04-15 10:21:26 
 */
import{f as A,cL as L,V as P,d as z,r as p,g as F,h as X,c as G,o as B,F as H,j as i,_ as J,a as s,y as K,m as u,w as O,k as Q,v as S,N as W,c0 as M,X as Z,bY as ee,c1 as k,z as ae}from"./index-5TqN_QR1.js";import{_ as te}from"./Form-BTPuTKGl.js";import{r as v}from"./formRules-CaONo6T9.js";import{u as oe}from"./useCrudSchemas-CkWaUHS3.js";import{b as re}from"./spu-BZrcAj3N.js";import{g as ie}from"./index-BSdZ3omu.js";import{_ as ne}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-CHbpPMBe.js";import{_ as se}from"./SpuSelect.vue_vue_type_script_setup_true_lang-ooecnx2x.js";const le=A({name:[v],startTime:[v],endTime:[v],helpMaxCount:[v],bargainCount:[v],singleLimitCount:[v]}),ce=A([{label:"砍价活动名称",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"活动开始时间",field:"startTime",formatter:L,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"活动结束时间",field:"endTime",formatter:L,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"砍价人数",field:"helpMaxCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"参与人数不能少于两人",value:2}},{label:"最大帮砍次数",field:"bargainCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"参与人数不能少于两人",value:2}},{label:"总限购数量",field:"totalLimitCount",isSearch:!1,form:{component:"InputNumber",labelMessage:"用户最大能发起砍价的次数",value:0}},{label:"砍价的最小金额",field:"randomMinPrice",isSearch:!1,isTable:!1,form:{component:"InputNumber",componentProps:{min:0,precision:2,step:.1},labelMessage:"用户每次砍价的最小金额",value:0}},{label:"砍价的最大金额",field:"randomMaxPrice",isSearch:!1,isTable:!1,form:{component:"InputNumber",componentProps:{min:0,precision:2,step:.1},labelMessage:"用户每次砍价的最大金额",value:0}},{label:"拼团商品",field:"spuId",isSearch:!1,form:{colProps:{span:24}}}]),{allSchemas:ue}=oe(ce),we=async l=>await P.get({url:"/promotion/bargain-activity/page",params:l}),me=async l=>await P.get({url:`/promotion/bargain-activity/get?id=${l}`}),pe=async l=>await P.post({url:"/promotion/bargain-activity/create",data:l}),de=async l=>await P.put({url:"/promotion/bargain-activity/update",data:l}),Ce=async l=>await P.put({url:`/promotion/bargain-activity/close?id=${l}`}),Fe=z({name:"PromotionBargainActivityForm",__name:"BargainActivityForm",emits:["success"],setup(l,{expose:R,emit:Y}){const{t:w}=W(),h=ae(),g=p(!1),V=p(""),b=p(!1),I=p(""),d=p(),x=p(),D=p(),y=p([]),C=p([]),N=[{name:"productConfig.bargainFirstPrice",rule:o=>o>0,message:"商品砍价起始价格不能小于 0 ！！！"},{name:"productConfig.bargainMinPrice",rule:o=>o>=0,message:"商品砍价底价不能小于 0 ！！！"},{name:"productConfig.stock",rule:o=>o>=1,message:"商品活动库存不能小于 1 ！！！"}],$=(o,e)=>{d.value.setValues({spuId:o}),T(o,e)},T=async(o,e,a)=>{const m=[],n=await re([o]);if(n.length==0)return;y.value=[];const c=n[0],_=typeof e>"u"?c?.skus:c?.skus?.filter(f=>e.includes(f.id));_?.forEach(f=>{let t={spuId:c.id,skuId:f.id,bargainFirstPrice:1,bargainMinPrice:1,stock:1};if(typeof a<"u"){const r=a.find(j=>j.skuId===f.id);r&&(r.bargainFirstPrice=M(r.bargainFirstPrice),r.bargainMinPrice=M(r.bargainMinPrice)),t=r||t}f.productConfig=t}),c.skus=_,m.push({spuId:c.id,spuDetail:c,propertyList:ie(c)}),y.value.push(c),C.value=m};R({open:async(o,e)=>{if(g.value=!0,V.value=w(`action.${o}`),I.value=o,await U(),e){b.value=!0;try{const a=await me(e);a.randomMinPrice=M(a.randomMinPrice),a.randomMaxPrice=M(a.randomMaxPrice),await T(a.spuId,[a.skuId],[{spuId:a.spuId,skuId:a.skuId,bargainFirstPrice:a.bargainFirstPrice,bargainMinPrice:a.bargainMinPrice,stock:a.stock}]),d.value.setValues(a)}finally{b.value=!1}}}});const U=async()=>{y.value=[],C.value=[],await Z(),d.value.getElFormRef().resetFields()},E=Y,q=async()=>{if(!(!d||!await d.value.getElFormRef().validate())){b.value=!0;try{const e=ee(d.value.formModel),a=D.value.getSkuConfigs("productConfig");a.forEach(n=>{n.bargainFirstPrice=k(n.bargainFirstPrice),n.bargainMinPrice=k(n.bargainMinPrice)}),e.randomMinPrice=k(e.randomMinPrice),e.randomMaxPrice=k(e.randomMaxPrice);const m={...e,...a[0]};I.value==="create"?(await pe(m),h.success(w("common.createSuccess"))):(await de(m),h.success(w("common.updateSuccess"))),g.value=!1,E("success")}finally{b.value=!1}}};return(o,e)=>{const a=F("el-button"),m=F("el-input-number"),n=F("el-table-column"),c=te,_=J,f=X("loading");return B(),G(H,null,[i(_,{modelValue:s(g),"onUpdate:modelValue":e[2]||(e[2]=t=>K(g)?g.value=t:null),title:s(V),width:"65%"},{footer:u(()=>[i(a,{disabled:s(b),type:"primary",onClick:q},{default:u(()=>e[4]||(e[4]=[S("确 定")])),_:1},8,["disabled"]),i(a,{onClick:e[1]||(e[1]=t=>g.value=!1)},{default:u(()=>e[5]||(e[5]=[S("取 消")])),_:1})]),default:u(()=>[O((B(),Q(c,{ref_key:"formRef",ref:d,class:"mt-10px","is-col":!0,rules:s(le),schema:s(ue).formSchema},{spuId:u(()=>[i(a,{onClick:e[0]||(e[0]=t=>s(x).open())},{default:u(()=>e[3]||(e[3]=[S("选择商品")])),_:1}),i(s(ne),{ref_key:"spuAndSkuListRef",ref:D,"rule-config":N,"spu-list":s(y),"spu-property-list-p":s(C)},{default:u(()=>[i(n,{align:"center",label:"砍价起始价格(元)","min-width":"168"},{default:u(({row:t})=>[i(m,{modelValue:t.productConfig.bargainFirstPrice,"onUpdate:modelValue":r=>t.productConfig.bargainFirstPrice=r,class:"w-100%",min:0,precision:2,step:.1},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(n,{align:"center",label:"砍价底价(元)","min-width":"168"},{default:u(({row:t})=>[i(m,{modelValue:t.productConfig.bargainMinPrice,"onUpdate:modelValue":r=>t.productConfig.bargainMinPrice=r,class:"w-100%",min:0,precision:2,step:.1},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(n,{align:"center",label:"活动库存","min-width":"168"},{default:u(({row:t})=>[i(m,{modelValue:t.productConfig.stock,"onUpdate:modelValue":r=>t.productConfig.stock=r,class:"w-100%"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[f,s(b)]])]),_:1},8,["modelValue","title"]),i(s(se),{ref_key:"spuSelectRef",ref:x,"is-select-sku":!0,radio:!0,onConfirm:$},null,512)],64)}}});export{Fe as _,Ce as c,we as g};
