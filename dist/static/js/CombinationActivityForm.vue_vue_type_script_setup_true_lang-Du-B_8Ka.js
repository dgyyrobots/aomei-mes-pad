/*!  build: Vue Shop Vite 
     copyright: https://vue-admin-beautiful.com/shop-vite  
     time: 2025-04-14 11:54:00 
 */
import{f as V,cL as I,d as z,r as l,g as C,h as G,c as U,o as L,F as O,j as r,_ as j,a,y as q,m as c,w as X,k as H,v as P,N as J,X as K,bY as R,c1 as Q,z as W,c0 as Z}from"./index-BdmDrM2Y.js";import{_ as ee}from"./Form-vqOdGcgT.js";import{r as u}from"./formRules-wW3jWK7m.js";import{D as te}from"./dict-Cm-9nniQ.js";import{u as oe}from"./useCrudSchemas-CKDeb1Cb.js";import{b as ae}from"./spu-DPwkyweT.js";import{g as se,c as ie,u as ne}from"./combinationActivity-DnLfNiIH.js";import{g as le}from"./index-K--N5cbR.js";import{_ as re}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-D3fq8rDW.js";import{_ as ce}from"./SpuSelect.vue_vue_type_script_setup_true_lang-eVDej1Mr.js";const ue=V({name:[u],totalLimitCount:[u],singleLimitCount:[u],startTime:[u],endTime:[u],userSize:[u],limitDuration:[u],virtualGroup:[u]}),me=V([{label:"拼团名称",field:"name",isSearch:!0,isTable:!1,form:{colProps:{span:24}}},{label:"活动开始时间",field:"startTime",formatter:I,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"活动结束时间",field:"endTime",formatter:I,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"参与人数",field:"userSize",isSearch:!1,form:{component:"InputNumber",labelMessage:"参与人数不能少于两人",value:2}},{label:"限制时长",field:"limitDuration",isSearch:!1,isTable:!1,form:{component:"InputNumber",labelMessage:"限制时长(小时)",componentProps:{placeholder:"请输入限制时长(小时)"}}},{label:"总限购数量",field:"totalLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"单次限购数量",field:"singleLimitCount",isSearch:!1,isTable:!1,form:{component:"InputNumber",value:0}},{label:"虚拟成团",field:"virtualGroup",dictType:te.INFRA_BOOLEAN_STRING,dictClass:"boolean",isSearch:!0,form:{component:"Radio",value:!1}},{label:"拼团商品",field:"spuId",isSearch:!1,form:{colProps:{span:24}}}]),{allSchemas:pe}=oe(me),De=z({name:"PromotionCombinationActivityForm",__name:"CombinationActivityForm",emits:["success"],setup(fe,{expose:N,emit:Y}){const{t:y}=J(),k=W(),f=l(!1),h=l(""),d=l(!1),D=l(""),m=l(),T=l(),w=l(),b=l([]),S=l([]),x=[{name:"productConfig.combinationPrice",rule:o=>o>=.01,message:"商品拼团价格不能小于0.01 ！！！"}],A=(o,e)=>{m.value.setValues({spuId:o}),F(o,e)},F=async(o,e,t)=>{const n=[],_=await ae([o]);if(_.length==0)return;b.value=[];const s=_[0],g=typeof e>"u"?s?.skus:s?.skus?.filter(p=>e.includes(p.id));g?.forEach(p=>{let i={spuId:s.id,skuId:p.id,combinationPrice:0};if(typeof t<"u"){const v=t.find(B=>B.skuId===p.id);v&&(v.combinationPrice=Z(v.combinationPrice)),i=v||i}p.productConfig=i}),s.skus=g,n.push({spuId:s.id,spuDetail:s,propertyList:le(s)}),b.value.push(s),S.value=n};N({open:async(o,e)=>{if(f.value=!0,h.value=y(`action.${o}`),D.value=o,await M(),e){d.value=!0;try{const t=await se(e);await F(t.spuId,t.products?.map(n=>n.skuId),t.products),m.value.setValues(t)}finally{d.value=!1}}}});const M=async()=>{b.value=[],S.value=[],await K(),m.value.getElFormRef().resetFields()},E=Y,$=async()=>{if(!(!m||!await m.value.getElFormRef().validate())){d.value=!0;try{const e=R(w.value.getSkuConfigs("productConfig"));e.forEach(n=>{n.combinationPrice=Q(n.combinationPrice)});const t=R(m.value.formModel);t.products=e,D.value==="create"?(await ie(t),k.success(y("common.createSuccess"))):(await ne(t),k.success(y("common.updateSuccess"))),f.value=!1,E("success")}finally{d.value=!1}}};return(o,e)=>{const t=C("el-button"),n=C("el-input-number"),_=C("el-table-column"),s=ee,g=j,p=G("loading");return L(),U(O,null,[r(g,{modelValue:a(f),"onUpdate:modelValue":e[2]||(e[2]=i=>q(f)?f.value=i:null),title:a(h),width:"65%"},{footer:c(()=>[r(t,{disabled:a(d),type:"primary",onClick:$},{default:c(()=>e[4]||(e[4]=[P("确 定")])),_:1},8,["disabled"]),r(t,{onClick:e[1]||(e[1]=i=>f.value=!1)},{default:c(()=>e[5]||(e[5]=[P("取 消")])),_:1})]),default:c(()=>[X((L(),H(s,{ref_key:"formRef",ref:m,class:"mt-10px","is-col":!0,rules:a(ue),schema:a(pe).formSchema},{spuId:c(()=>[r(t,{onClick:e[0]||(e[0]=i=>a(T).open())},{default:c(()=>e[3]||(e[3]=[P("选择商品")])),_:1}),r(a(re),{ref_key:"spuAndSkuListRef",ref:w,"rule-config":x,"spu-list":a(b),"spu-property-list-p":a(S)},{default:c(()=>[r(_,{align:"center",label:"拼团价格(元)","min-width":"168"},{default:c(({row:i})=>[r(n,{modelValue:i.productConfig.combinationPrice,"onUpdate:modelValue":v=>i.productConfig.combinationPrice=v,class:"w-100%",min:0,precision:2,step:.1},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[p,a(d)]])]),_:1},8,["modelValue","title"]),r(a(ce),{ref_key:"spuSelectRef",ref:T,"is-select-sku":!0,onConfirm:A},null,512)],64)}}});export{De as _};
