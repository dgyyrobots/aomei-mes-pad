/*!  build: Vue Shop Vite 
     copyright: https://vue-admin-beautiful.com/shop-vite  
     time: 2025-04-15 10:21:26 
 */
import{f as T,cL as I,d as U,r,g as S,h as B,c as j,o as L,F as q,j as i,_ as z,a as l,y as X,m as c,w as G,k as H,v as w,N as J,bY as K,c1 as O,z as Q,X as W,c0 as Z}from"./index-5TqN_QR1.js";import{_ as ee}from"./Form-BTPuTKGl.js";import{_ as te}from"./SpuAndSkuList.vue_vue_type_script_setup_true_lang-CHbpPMBe.js";import{_ as oe}from"./SpuSelect.vue_vue_type_script_setup_true_lang-ooecnx2x.js";import{g as se}from"./seckillConfig-Dg3QI32m.js";import{r as u}from"./formRules-CaONo6T9.js";import{u as le}from"./useCrudSchemas-CkWaUHS3.js";import{b as ae}from"./spu-BZrcAj3N.js";import{g as ie,c as ne,u as re}from"./seckillActivity-DK93RKat.js";import{g as ce}from"./index-BSdZ3omu.js";const ue=T({spuId:[u],name:[u],startTime:[u],endTime:[u],sort:[u],configIds:[u],totalLimitCount:[u],singleLimitCount:[u],totalStock:[u]}),me=T([{label:"秒杀活动名称",field:"name",isSearch:!0,form:{colProps:{span:24}},table:{width:120}},{label:"活动开始时间",field:"startTime",formatter:I,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"活动结束时间",field:"endTime",formatter:I,isSearch:!0,search:{component:"DatePicker",componentProps:{valueFormat:"YYYY-MM-DD",type:"daterange"}},form:{component:"DatePicker",componentProps:{type:"date",valueFormat:"x"}},table:{width:120}},{label:"秒杀时段",field:"configIds",form:{component:"Select",componentProps:{multiple:!0,optionsAlias:{labelField:"name",valueField:"id"}},api:se},table:{width:300}},{label:"总限购数量",field:"totalLimitCount",form:{component:"InputNumber",value:0},table:{width:120}},{label:"单次限够数量",field:"singleLimitCount",form:{component:"InputNumber",value:0},table:{width:120}},{label:"排序",field:"sort",form:{component:"InputNumber",value:0},table:{width:80}},{label:"秒杀活动商品",field:"spuId",isTable:!0,isSearch:!1,form:{colProps:{span:24}},table:{width:300}},{label:"备注",field:"remark",isSearch:!1,form:{component:"Input",componentProps:{type:"textarea",rows:4},colProps:{span:24}},table:{width:300}}]),{allSchemas:pe}=le(me),he=U({name:"PromotionSeckillActivityForm",__name:"SeckillActivityForm",emits:["success"],setup(de,{expose:x,emit:R}){const{t:b}=J(),P=Q(),f=r(!1),C=r(""),v=r(!1),h=r(""),p=r(),F=r(),V=r(),Y=[{name:"productConfig.stock",rule:o=>o>=1,message:"商品秒杀库存必须大于等于 1 ！！！"},{name:"productConfig.seckillPrice",rule:o=>o>=.01,message:"商品秒杀价格必须大于等于 0.01 ！！！"}],k=r([]),y=r([]),A=(o,e)=>{p.value.setValues({spuId:o}),D(o,e)},D=async(o,e,t)=>{const a=[],g=await ae([o]);if(g.length==0)return;k.value=[];const n=g[0],_=typeof e>"u"?n?.skus:n?.skus?.filter(d=>e.includes(d.id));_?.forEach(d=>{let s={skuId:d.id,stock:0,seckillPrice:0};if(typeof t<"u"){const m=t.find(E=>E.skuId===d.id);m&&(m.seckillPrice=Z(m.seckillPrice)),s=m||s}d.productConfig=s}),n.skus=_,a.push({spuId:n.id,spuDetail:n,propertyList:ce(n)}),k.value.push(n),y.value=a};x({open:async(o,e)=>{if(f.value=!0,C.value=b(`action.${o}`),h.value=o,await $(),e){v.value=!0;try{const t=await ie(e);await D(t.spuId,t.products?.map(a=>a.skuId),t.products),p.value.setValues(t)}finally{v.value=!1}}}});const M=R,N=async()=>{if(!(!p||!await p.value.getElFormRef().validate())){v.value=!0;try{const e=K(V.value.getSkuConfigs("productConfig"));e.forEach(a=>{a.seckillPrice=O(a.seckillPrice)});const t=p.value.formModel;t.products=e,h.value==="create"?(await ne(t),P.success(b("common.createSuccess"))):(await re(t),P.success(b("common.updateSuccess"))),f.value=!1,M("success")}finally{v.value=!1}}},$=async()=>{k.value=[],y.value=[],await W(),p.value.getElFormRef().resetFields()};return(o,e)=>{const t=S("el-button"),a=S("el-input-number"),g=S("el-table-column"),n=ee,_=z,d=B("loading");return L(),j(q,null,[i(_,{modelValue:l(f),"onUpdate:modelValue":e[2]||(e[2]=s=>X(f)?f.value=s:null),title:l(C),width:"65%"},{footer:c(()=>[i(t,{disabled:l(v),type:"primary",onClick:N},{default:c(()=>e[4]||(e[4]=[w("确 定")])),_:1},8,["disabled"]),i(t,{onClick:e[1]||(e[1]=s=>f.value=!1)},{default:c(()=>e[5]||(e[5]=[w("取 消")])),_:1})]),default:c(()=>[G((L(),H(n,{ref_key:"formRef",ref:p,"is-col":!0,rules:l(ue),schema:l(pe).formSchema},{spuId:c(()=>[i(t,{onClick:e[0]||(e[0]=s=>l(F).open())},{default:c(()=>e[3]||(e[3]=[w("选择商品")])),_:1}),i(l(te),{ref_key:"spuAndSkuListRef",ref:V,"rule-config":Y,"spu-list":l(k),"spu-property-list-p":l(y)},{default:c(()=>[i(g,{align:"center",label:"秒杀库存","min-width":"168"},{default:c(({row:s})=>[i(a,{modelValue:s.productConfig.stock,"onUpdate:modelValue":m=>s.productConfig.stock=m,class:"w-100%",min:0},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),i(g,{align:"center",label:"秒杀价格(元)","min-width":"168"},{default:c(({row:s})=>[i(a,{modelValue:s.productConfig.seckillPrice,"onUpdate:modelValue":m=>s.productConfig.seckillPrice=m,class:"w-100%",min:0,precision:2,step:.1},null,8,["modelValue","onUpdate:modelValue"])]),_:1})]),_:1},8,["spu-list","spu-property-list-p"])]),_:1},8,["rules","schema"])),[[d,l(v)]])]),_:1},8,["modelValue","title"]),i(l(oe),{ref_key:"spuSelectRef",ref:F,"is-select-sku":!0,onConfirm:A},null,512)],64)}}});export{he as _};
